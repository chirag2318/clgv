<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard — BharatPass</title>
    <link rel="stylesheet" href="../css/style.css" />
    <style>
        .date-edit {
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.82rem;
        }

        .action-btns {
            display: flex;
            gap: 6px;
        }

        .scan-log-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            transition: var(--transition);
        }

        .scan-log-item:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .scan-log-icon {
            font-size: 1.3rem;
            width: 32px;
            text-align: center;
        }

        .scan-log-meta {
            flex: 1;
        }

        .scan-log-main {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .scan-log-sub {
            font-size: 0.78rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .scan-log-time {
            font-size: 0.78rem;
            color: var(--text-muted);
            text-align: right;
        }

        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 6px 16px;
            border-radius: 999px;
            font-size: 0.82rem;
            font-weight: 500;
            border: 1px solid var(--glass-border);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .filter-btn.active {
            background: rgba(79, 142, 247, 0.15);
            border-color: rgba(79, 142, 247, 0.4);
            color: var(--accent-blue);
        }
    </style>
</head>

<body>
    <div class="bg-orbs">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
    </div>

    <div class="dashboard">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <div class="sidebar-logo-icon"><img src="../images/logo.jpeg" alt="BharatPass"
                        style="width:32px;height:32px;border-radius:8px;object-fit:cover;" /></div>
                <span>Admin Panel</span>
            </div>
            <nav class="sidebar-nav">
                <div class="sidebar-item active" onclick="switchSection('overview')"><span
                        class="icon">📊</span><span>Overview</span></div>
                <div class="sidebar-item" onclick="switchSection('passes')"><span class="icon">🎫</span><span>All
                        Passes</span></div>
                <div class="sidebar-link" onclick="switchSection('users')">👥 User Management</div>
                <div class="sidebar-link" onclick="switchSection('scanlogs')">📋 Scan Logs</div>
                <div class="sidebar-divider"></div>
                <div class="sidebar-link" onclick="switchSection('settings')">⚙️ System Settings</div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="sidebar-user-avatar"
                        style="background:linear-gradient(135deg,#6c63ff,#4f8ef7);">A</div>
                    <div class="user-details">
                        <div class="user-name" id="sidebar-user-name">Admin</div>
                        <div class="user-role" id="sidebar-user-role">Administrator</div>
                    </div>
                </div>
                <button class="btn btn-secondary btn-sm btn-full" style="margin-top:10px;" onclick="logout()">🚪
                    Logout</button>
            </div>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <h1 id="section-title">Overview</h1>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">🌙</button>
                    <button class="btn btn-secondary btn-sm" onclick="resetDB();location.reload();">🔄 Reset
                        Data</button>
                </div>
            </header>

            <div class="main-body">
                <!-- Overview -->
                <div id="section-overview">
                    <div class="stats-grid" id="stats-grid" style="margin-bottom:32px;"></div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;">
                        <div class="card">
                            <div
                                style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                                <h3 style="font-size:1rem;font-weight:600;">Recent Applications</h3>
                                <button class="btn btn-secondary btn-sm" onclick="switchSection('passes')">View All
                                    →</button>
                            </div>
                            <div id="recent-passes"></div>
                        </div>
                        <div class="card">
                            <div
                                style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                                <h3 style="font-size:1rem;font-weight:600;">Recent Scans</h3>
                                <button class="btn btn-secondary btn-sm" onclick="switchSection('scanlogs')">View All
                                    →</button>
                            </div>
                            <div id="recent-scans"></div>
                        </div>
                    </div>
                </div>

                <!-- Passes -->
                <div id="section-passes" style="display:none;">
                    <div class="filter-bar">
                        <button class="filter-btn active" data-filter="all"
                            onclick="filterPasses('all',this)">All</button>
                        <button class="filter-btn" data-filter="pending" onclick="filterPasses('pending',this)">⏳
                            Pending</button>
                        <button class="filter-btn" data-filter="active" onclick="filterPasses('active',this)">✅
                            Active</button>
                        <button class="filter-btn" data-filter="expired" onclick="filterPasses('expired',this)">❌
                            Expired</button>
                        <button class="filter-btn" data-filter="rejected" onclick="filterPasses('rejected',this)">🚫
                            Rejected</button>
                    </div>
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>Pass ID</th>
                                    <th>Passenger</th>
                                    <th>City</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Valid Until</th>
                                    <th>Price</th>
                                    <th>Payment ID</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="passes-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Users -->
                <div id="section-users" style="display:none;">
                    <div class="table-wrap">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Passes</th>
                                    <th>Joined</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Scan Logs -->
                <div id="section-scanlogs" style="display:none;">
                    <div class="card" style="padding:0;overflow:hidden;">
                        <div id="scan-logs-list"></div>
                    </div>
                </div>

                <!-- Settings Section -->
                <section id="section-settings" style="display:none;">
                    <div class="section-header">
                        <h2 class="section-title">⚙️ System Settings</h2>
                        <p class="section-subtitle">Manage cities and pass pricing</p>
                    </div>

                    <div
                        style="display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:24px;margin-top:24px;">
                        <!-- City Management -->
                        <div class="card">
                            <h3 style="margin-bottom:16px;">🏙️ City Management</h3>
                            <div id="city-list" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;">
                                <!-- Cities will be loaded here -->
                            </div>
                            <div style="display:flex;gap:8px;">
                                <input type="text" id="new-city-input" class="form-control"
                                    placeholder="Add new city..." style="flex:1;">
                                <button class="btn btn-primary" onclick="addCity()">Add</button>
                            </div>
                        </div>

                        <!-- Price Management -->
                        <div class="card">
                            <h3 style="margin-bottom:16px;">💰 Pass Pricing (₹)</h3>
                            <div class="form-group">
                                <label class="form-label">Monthly Pass</label>
                                <input type="number" id="price-monthly" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Quarterly Pass</label>
                                <input type="number" id="price-quarterly" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Yearly Pass</label>
                                <input type="number" id="price-yearly" class="form-control">
                            </div>
                            <button class="btn btn-primary btn-full" onclick="savePrices()"
                                style="margin-top:16px;">Save Pricing</button>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script src="../js/app.js"></script>
    <script>
        let currentSession = null;
        let currentFilter = 'all';
        let cachedPasses = [];
        let cachedUsers = []; // Added for consistency, though not explicitly in instruction for this file
        let currentSettings = null;

        window.addEventListener('DOMContentLoaded', () => {
            currentSession = requireAuth('admin');
            if (!currentSession) return;
            initSidebar();
            renderAll();
        });

        function switchSection(name) {
            ['overview', 'passes', 'users', 'scanlogs', 'settings'].forEach(s => {
                document.getElementById(`section-${s}`).style.display = s === name ? '' : 'none';
            });
            document.querySelectorAll('.sidebar-item, .sidebar-link').forEach((el) => {
                el.classList.remove('active');
            });
            const activeElement = document.querySelector(`.sidebar-item[onclick="switchSection('${name}')"]`) ||
                document.querySelector(`.sidebar-link[onclick="switchSection('${name}')"]`);
            if (activeElement) {
                activeElement.classList.add('active');
            }
            const titles = { overview: 'Overview', passes: 'All Passes', users: 'User Management', scanlogs: 'Scan Logs', settings: 'System Settings' };
            document.getElementById('section-title').textContent = titles[name] || '';
        }

        async function renderAll() {
            try {
                // Fetch settings first
                currentSettings = await fetch(`${API_URL}/api/settings`).then(r => r.json());

                cachedPasses = await fetch(`${API_URL}/api/passes`).then(r => r.json());
                cachedUsers = await fetch(`${API_URL}/api/admin/users`).then(r => r.json());
                renderStats();
                renderPasses();
                renderUsers();
                renderScanLogs();
                renderRecentPasses();
                renderSettings();
            } catch (err) {
                console.error('Failed to fetch data:', err);
                showToast('Failed to load dashboard data', 'error');
            }
        }

        async function renderStats() {
            try {
                const s = await fetch(`${API_URL}/api/admin/stats`).then(r => r.json());
                const gradients = [
                    'var(--gradient-primary)', 'var(--gradient-green)', 'var(--gradient-orange)',
                    'var(--gradient-cyan)', 'linear-gradient(135deg,#6c63ff,#9c89ff)', 'var(--gradient-red)'
                ];
                const stats = [
                    { label: 'Total Passes', value: s.totalPasses, sub: `${s.pendingPasses} pending`, icon: '🎫' },
                    { label: 'Active Passes', value: s.activePasses, sub: 'Currently valid', icon: '✅' },
                    { label: 'Total Revenue', value: `₹${(s.revenue || 0).toLocaleString('en-IN')}`, sub: 'All time', icon: '💰' },
                    { label: 'Total Users', value: s.users, sub: 'Registered passengers', icon: '👥' },
                    { label: 'Pending Review', value: s.pendingPasses, sub: 'Awaiting approval', icon: '⏳' },
                    { label: 'Total Scans', value: s.logs, sub: 'By conductors', icon: '📡' },
                ];
                document.getElementById('stats-grid').innerHTML = stats.map((st, i) => `
                    <div class="stat-card" style="border-color:rgba(255,255,255,0.06);">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                        <div class="stat-label">${st.label}</div>
                        <span style="font-size:1.4rem;">${st.icon}</span>
                    </div>
                    <div class="stat-value" style="background:${gradients[i]};-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">${st.value}</div>
                    <div class="stat-sub">${st.sub}</div>
                    </div>`).join('');
            } catch (err) { console.error('Stats error:', err); }
        }

        async function fetchAllPasses() {
            cachedPasses = await fetch(`${API_URL}/api/passes`).then(r => r.json());
            // Map userId to user object if needed, but the backend is currently simplistic.
            return cachedPasses;
        }

        async function renderPasses(filter = 'all') {
            currentFilter = filter;
            try {
                const passes = await fetchAllPasses();
                const filtered = filter === 'all' ? passes : passes.filter(p => p.status === filter);
                document.getElementById('passes-table-body').innerHTML = filtered.map(p => `
                    <tr>
                    <td style="font-family:monospace;font-size:0.82rem;">${(p.id || p._id).slice(-8).toUpperCase()}</td>
                    <td>
                        <div style="font-weight:500;font-size:0.9rem;">${p.name || 'Passenger'}</div>
                        <div style="font-size:0.75rem;color:var(--text-muted);">ID: ${p.userId || '-'}</div>
                    </td>
                    <td style="font-size:0.85rem;">${p.city || p.route}</td>
                    <td>${getBadgeTypeHTML(p.passType)}</td>
                    <td>${getBadgeHTML(p.status)}</td>
                    <td style="font-size:0.85rem;">${formatDate(p.validUntil)}</td>
                    <td style="color:var(--accent-green);font-weight:600;">₹${p.price}</td>
                    <td style="font-family:monospace;font-size:0.75rem;color:var(--text-muted);">${p.razorpayPaymentId || '-'}</td>
                    <td>
                        <div class="action-btns">
                        ${p.status === 'pending' ? `
                            <button class="btn btn-sm" style="background:rgba(0,230,118,0.15);color:var(--accent-green);border:1px solid rgba(0,230,118,0.3);" onclick="approvePass('${p._id}')">✅ Approve</button>
                            <button class="btn btn-sm" style="background:rgba(255,71,87,0.1);color:var(--accent-red);border:1px solid rgba(255,71,87,0.25);" onclick="rejectPass('${p._id}')">❌ Reject</button>
                        ` : ''}
                        </div>
                    </td>
                    </tr>`).join('') || `<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text-muted);">No passes found</td></tr>`;
            } catch (err) { console.error(err); }
        }

        function filterPasses(filter, el) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            renderPasses(filter);
        }

        async function renderUsers() {
            try {
                const users = await fetch(`${API_URL}/api/admin/users`).then(r => r.json());
                document.getElementById('users-table-body').innerHTML = users.map(u => {
                    const roleColors = { admin: 'var(--accent-indigo)', user: 'var(--accent-blue)', conductor: 'var(--accent-green)' };
                    return `<tr>
                        <td>
                            <div style="display:flex;align-items:center;gap:10px;">
                            <div style="width:32px;height:32px;border-radius:50%;background:var(--gradient-primary);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.85rem;flex-shrink:0;">${u.name?.charAt(0)?.toUpperCase()}</div>
                            <span style="font-weight:500;">${u.name}</span>
                            </div>
                        </td>
                        <td style="color:var(--text-secondary);font-size:0.88rem;">${u.email}</td>
                        <td><span style="color:${roleColors[u.role]};font-weight:600;font-size:0.85rem;">${u.role.charAt(0).toUpperCase() + u.role.slice(1)}</span></td>
                        <td style="font-weight:600;">-</td>
                        <td style="color:var(--text-muted);font-size:0.85rem;">${formatDate(u.createdAt)}</td>
                    </tr>`;
                }).join('');
            } catch (err) { console.error(err); }
        }

        async function renderScanLogs() {
            try {
                const logs = await fetch(`${API_URL}/api/conductor/logs`).then(r => r.json());
                const icons = { valid: '✅', expired: '❌', invalid: '⛔' };
                const resultColors = { valid: 'var(--accent-green)', expired: 'var(--accent-orange)', invalid: 'var(--accent-red)' };
                document.getElementById('scan-logs-list').innerHTML = logs.map(l => `
                    <div class="scan-log-item">
                    <div class="scan-log-icon">${icons[l.result] || '❓'}</div>
                    <div class="scan-log-meta">
                        <div class="scan-log-main">${l.passengerName || 'Passenger'} — <span style="color:${resultColors[l.result]};font-weight:600;">${l.result?.toUpperCase()}</span></div>
                        <div class="scan-log-sub">${l.city || l.route || 'City'} · Pass ID: ${(l.passId || '-').slice(-8).toUpperCase()}</div>
                    </div>
                    <div class="scan-log-time">${formatDateTime(l.scannedAt)}</div>
                    </div>`).join('') || '<div style="padding:40px;text-align:center;color:var(--text-muted);">No scan logs yet</div>';
            } catch (err) { console.error(err); }
        }

        async function renderRecentPasses() {
            const passes = cachedPasses.slice(0, 5);
            document.getElementById('recent-passes').innerHTML = passes.map(p => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.04);">
                <div>
                    <div style="font-size:0.85rem;font-weight:500;">Passenger ID: ${p.userId?.slice(-6) || 'New'}</div>
                    <div style="font-size:0.75rem;color:var(--text-muted);">${p.city || p.route} · ${p.passType}</div>
                </div>
                <div style="display:flex;gap:8px;align-items:center;">
                    ${getBadgeHTML(p.status)}
                    ${p.status === 'pending' ? `<button class="btn btn-sm" style="background:rgba(0,230,118,0.15);color:var(--accent-green);border:1px solid rgba(0,230,118,0.3);" onclick="approvePass('${p._id}')">✅</button>` : ''}
                </div>
                </div>`).join('') || '<div class="empty-state" style="padding:20px;">No passes yet</div>';
        }

        async function renderRecentScans() {
            // Re-using scan log list for simplicity in recent scans for now
            renderScanLogs();
        }

        function renderSettings() {
            if (!currentSettings) return;

            // Render Cities
            const cityContainer = document.getElementById('city-list');
            cityContainer.innerHTML = currentSettings.cities.map(city => `
                <div style="background:rgba(255,255,255,0.05);padding:6px 12px;border-radius:20px;display:flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,0.1);">
                    <span style="font-size:0.9rem;">${city}</span>
                    <span style="cursor:pointer;color:var(--accent-red);font-weight:bold;" onclick="removeCity('${city}')">×</span>
                </div>`).join('');

            // Render Prices
            document.getElementById('price-monthly').value = currentSettings.prices.monthly;
            document.getElementById('price-quarterly').value = currentSettings.prices.quarterly;
            document.getElementById('price-yearly').value = currentSettings.prices.yearly;
        }

        async function addCity() {
            const input = document.getElementById('new-city-input');
            const city = input.value.trim();
            if (!city) return;
            if (currentSettings.cities.includes(city)) {
                showToast('City already exists', 'error');
                return;
            }

            const newCities = [...currentSettings.cities, city].sort();
            await updateSettings({ cities: newCities });
            input.value = '';
        }

        async function removeCity(city) {
            if (!confirm(`Are you sure you want to remove ${city}?`)) return;
            const newCities = currentSettings.cities.filter(c => c !== city);
            await updateSettings({ cities: newCities });
        }

        async function savePrices() {
            const prices = {
                monthly: parseInt(document.getElementById('price-monthly').value),
                quarterly: parseInt(document.getElementById('price-quarterly').value),
                yearly: parseInt(document.getElementById('price-yearly').value)
            };
            await updateSettings({ prices });
        }

        async function updateSettings(data) {
            try {
                const res = await apiPost('/api/admin/settings', data);
                currentSettings = res;
                renderSettings();
                showToast('Settings updated!', 'success');
            } catch (err) {
                showToast('Failed to update settings', 'error');
            }
        }

        // Actions
        async function approvePass(passId) {
            try {
                const pass = cachedPasses.find(p => p._id === passId);
                if (!pass) return;

                const durations = { monthly: 30, quarterly: 90, yearly: 365 };
                const days = durations[pass.passType] || 30;

                const qrToken = generateToken();
                const validFrom = new Date().toISOString().split('T')[0];
                const validUntil = addDays(new Date(), days);

                await apiPost('/api/admin/approve-pass', {
                    passId,
                    validFrom,
                    validUntil,
                    qrToken
                });
                showToast('Pass approved and active!', 'success');
                renderAll();
            } catch (err) { showToast('Approval failed', 'error'); }
        }

        async function rejectPass(passId) {
            try {
                await apiPost('/api/admin/reject-pass', { passId });
                showToast('Pass rejected.', 'info');
                renderAll();
            } catch (err) { showToast('Rejection failed', 'error'); }
        }

        async function resetDB() {
            if (!confirm('This will clear all registered data and reset to demo state. Continue?')) return;
            try {
                await apiPost('/api/admin/seed', {});
                showToast('Database reset successfully!', 'success');
                location.reload();
            } catch (err) { showToast('Reset failed', 'error'); }
        }
    </script>
</body>

</html>
```